const log = require("@jasonfleischer/log")

class Midi {
	
	constructor(noteOn, noteOff){

		this.noteOn = noteOn;
		this.noteOff = noteOff;

		navigator.requestMIDIAccess().then(function(access) {
			console.log('access', access);
			this.devices = access.inputs.values();
			access.onstatechange = function(e) {
				this.devices = Array.from(this.inputs.values());
			}
    	}
	}

	connectToFirstDevice() {
		let device = this.devices[0];
		connectToDevice(device)
	}

	connectToDevice(device) {
	  	log.e('Connecting to device: ' + device);
	  	this.connectedDevice = device;
	  	device.onmidimessage = function(m) {
		    const [command, midi_value, velocity] = m.data;

		    let KEY_UP = 145;
		    let KEY_DOWN = 129;

		    if (command === KEY_UP) {
		    	log.e('KEY UP: ' + midi_value);
		    	this.noteOff(midi_value, velocity);
		    } else if(command === KEY_DOWN) {
		      	log.e('KEY DOWN'+ midi_value);
		      	this.noteOn(midi_value, velocity);
		    }
		 }
	}


	deviceToString(device) {
		return device.name + ' ' + device.manufacturer;
	}
}

module.exports = Midi